!function(e){var n=null,a=(window.URL||window.webkitURL||window.msURL||window.oURL,navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.mozRTCIceCandidate||window.RTCIceCandidate),o=window.mozRTCSessionDescription||window.RTCSessionDescription,t=(navigator.mozGetUserMedia,{iceServers:[]}),s=512,m="x-google-max-bitrate",h="maxaveragebitrate";function r(){this.events={}}function c(){if(!((n=this)instanceof c))return new c;this.pcPuber=null,this.pcPuberPubId="",this.sender=[],this.localMediaStream=null,this.scrnPuber=null,this.scrnMediaStream=null,this.audioDetect=!0,this.filterExcept=!1,this.strSubFilterPeerid="",this.subscribers={},this.peerConnections={},this.peerStates={},this.peerVideoLastIndex={},this.numStreams=0,this.initializedStreams=0,this.version="V2018.07.05.001"}function d(m,e){var h=n;e.getStats(null).then(function(e){e.forEach(function(e){e.timestamp;if(!h.peerStates[m]&&(h.peerStates[m]={}),"track"===e.type)if("audio"===e.kind){var t=e.audioLevel;t=parseInt(100*t),h.peerStates[m].audioLevel=t;var i=null;for(var n in h.subscribers)if(h.subscribers[n]==m){null!=(i=n)&&h.emit("onPeerAudioDetect",i,t);break}}else e.kind;if("transport"===e.type){var r=h.peerStates[m].lastNetBytes?h.peerStates[m].lastNetBytes:"",a=e.bytesReceived;h.peerStates[m].lastNetBytes=a;var o=parseInt((a-r)/1024*8);h.peerStates[m].netBytes=o}if("inbound-rtp"===e.type&&"video"===e.mediaType){if(h.peerVideoLastIndex[m]=isNaN(h.peerVideoLastIndex[m])?1:h.peerVideoLastIndex[m],(h.peerVideoLastIndex[m]-1)%4==0){var s=h.peerStates[m].lastBytes?h.peerStates[m].lastBytes:"",c=e.bytesReceived;h.peerStates[m].lastBytes=c;var d=parseInt((c-s)/1024*8);if(null!=(h.peerStates[m].videoBytes=d)){i=null;for(var n in h.subscribers)if(h.subscribers[n]==m){null!=(i=n)&&h.emit("onPeerVideoBytes",i,d);break}}var l=h.peerStates[m].lastPacketsLost?h.peerStates[m].lastPacketsLost:"",p=e.packetsLost;h.peerStates[m].lastPacketsLost=p;var u=parseInt(p-l);if(h.peerStates[m].pkgLost=u,null!==h.peerStates[m].netBytes&&void 0!==h.peerStates[m].netBytes&&null!=u){i=null;for(var n in h.subscribers)if(h.subscribers[n]==m){null!=(i=n)&&h.emit("onRTCNetworkStatus",i,h.peerStates[m].netBytes,u);break}}}h.peerVideoLastIndex[m]++}})},function(e){console.log(e)})}r.prototype.on=function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)},r.prototype.emit=function(e,t){var i,n,r=this.events[e],a=Array.prototype.slice.call(arguments,1);if(r)for(i=0,n=r.length;i<n;i++)r[i].apply(null,a)},(c.prototype=new r).setSubscribeFileter=function(e,t){this.filterExcept=t,this.strSubFilterPeerid=e},c.prototype.sendOffer=function(n,e){var r,a=this;e.createOffer((r=e,function(e){r.setLocalDescription(e);var t={sdp:e.sdp,type:e.type},i=JSON.stringify({anyrtc:"message",body:{request:"configure",audio:!0,video:!0},transaction:"x8981",jsep:t});a.emit("onSendToPeer",n,i)}),function(e){console.log(e)})},c.prototype.createPublisher=function(e,t){var i=this;if(null==i.peerConnections[e]){var n=i.createPeerConnection(e);n.rtcType="PubVid",i.pcPuber=n,i.pcPuberPubId=t,i.localMediaStream&&i.localMediaStream.getTracks().forEach(function(e){var t=i.pcPuber.addTrack(e,i.localMediaStream);i.sender.push(t)}),i.sendOffer(e,n)}},c.prototype.destroyPublisher=function(e){var t=this,i=t.peerConnections[e];null!=i&&(t.closePeerConnection(i),delete t.peerConnections[e])},c.prototype.createPublisherEx=function(e){var t=this;if(null==t.peerConnections[e]){var i=t.createPeerConnection(e);i.rtcType="PubScrn",(t.scrnPuber=i).addStream(t.scrnMediaStream),t.sendOffer(e,i)}},c.prototype.destroyPublisherEx=function(e){var t=this,i=t.peerConnections[e];null!=i&&(null!=t.scrnMediaStream&&(i.removeStream(t.scrnMediaStream),t.scrnMediaStream=null),t.closePeerConnection(i),delete t.peerConnections[e]),t.scrnPuber=null},c.prototype.createSubscriber=function(n,e,t){var r=this;if(null==r.peerConnections[n]){r.subscribers[e]=n;var a=r.createPeerConnection(n);a.rtcType="Suber",a.setRemoteDescription(new o(t),function(){},function(e){console.log(e)}),r.emit("onMemberJoin",e),a.createAnswer(function(e){a.setLocalDescription(e);var t={sdp:e.sdp,type:e.type},i=JSON.stringify({anyrtc:"message",body:{request:"start",room:"12345"},transaction:"x8981",jsep:t});r.emit("onSendToPeer",n,i)},function(e){console.log(e)})}},c.prototype.destroySubscriber=function(e){var t=this,i=t.subscribers[e];if(null!=i){var n=t.peerConnections[i];null!=n&&(t.closePeerConnection(n),delete t.peerConnections[i],t.emit("onMemberLeave",e)),null!=t.peerVideoLastIndex[i]&&delete t.peerVideoLastIndex[i],null!=t.peerStates[i]&&delete t.peerStates[i],delete t.subscribers[e]}return i},c.prototype.destroyAll=function(){for(connection in c.prototype.events={},this.peerConnections){var e=this.peerConnections[connection];this.closePeerConnection(e),delete this.peerConnections[connection]}},c.prototype.getSdpInfo=function(e,t){var i=this.peerConnections[e];if(null!=i){var n=JSON.parse(t);if(null!=n.type)null!=i.rtcType&&"PubScrn"==i.rtcType?(n.sdp=l("VP9",!0,n.sdp,128),n.sdp=l("VP8",!0,n.sdp,128),n.sdp=l("H264",!0,n.sdp,128)):(n.sdp=l("VP9",!0,n.sdp,s),n.sdp=l("VP8",!0,n.sdp,s),n.sdp=l("H264",!0,n.sdp,s)),n.sdp=l("opus",!1,n.sdp,20),i.setRemoteDescription(new o(n),function(){},function(e){console.log(e)});else{var r=new a({sdpMLineIndex:n.sdpMLineIndex,candidate:n.candidate});i.addIceCandidate(r)}}},c.prototype.createStream=function(){var e,t=this,i=null,n=null,r=null,a=null,o=null;if("object"!=typeof arguments[0]||(""!==(i=arguments[0]).cameraDeviceId&&void 0!==i.cameraDeviceId&&null!==i.cameraDeviceId&&(a=i.cameraDeviceId),""!==i.microphoneDeviceId&&void 0!==i.microphoneDeviceId&&null!==i.microphoneDeviceId&&(o=i.microphoneDeviceId)),"string"!=typeof arguments[1]||(n=arguments[1]),"object"!=typeof arguments[2]&&-1===Object.prototype.toString.call(r).indexOf("[object HTML")||(r=arguments[2]),i.needMicrophone){switch(n){case"RTCMeet_Videos_Flow":case"AnyRTCVideoQuality_Low1":s=128,e={video:!!i.needCamera&&p({width:320,height:240},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTCP_Videos_Low":case"RTCMeet_Videos_Low":case"AnyRTCVideoQuality_Low2":s=256,e={video:!!i.needCamera&&p({width:{max:352,ideal:352,min:320},height:{max:288,ideal:288,min:240}},a),audio:!!i.needMicrophone&&p({},o)};break;case"AnyRTCVideoQuality_Low3":s=384,e={video:!!i.needCamera&&p({width:{max:352,ideal:352,min:320},height:{max:288,ideal:288,min:240}},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTMPC_Video_Low":case"AnyRTCVideoQuality_Medium1":s=384,e={video:!!i.needCamera&&p({width:{max:640,ideal:640,min:352},height:{max:480,ideal:480,min:288}},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTCMeet_Videos_SD":case"RTMPC_Video_SD":case"RTCP_Videos_SD":case"AnyRTCVideoQuality_Medium2":s=512,e={video:!!i.needCamera&&p({width:{max:640,ideal:640,min:352},height:{max:480,ideal:480,min:288}},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTMPC_Video_QHD":case"AnyRTCVideoQuality_Medium3":s=768,e={video:!!i.needCamera&&p({width:{max:640,ideal:640,min:352},height:{max:480,ideal:480,min:288}},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTCP_Videos_QHD":case"AnyRTCVideoQuality_Height1":s=1024,e={video:!!i.needCamera&&p({width:{max:640,ideal:640,min:352},height:{max:480,ideal:480,min:288}},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTCMeet_Videos_HD":case"RTMPC_Video_HD":case"RTCP_Videos_HD":case"AnyRTCVideoQuality_Height2":s=1280,e={video:!!i.needCamera&&p({width:{max:1280,ideal:1280,min:640},height:{max:720,ideal:720,min:480}},a),audio:!!i.needMicrophone&&p({},o)};break;case"RTCMeet_Videos_HHD":case"RTMPC_Video_1080P":case"AnyRTCVideoQuality_Height3":s=2048,e={video:!!i.needCamera&&p({width:{max:1920,ideal:1920,min:1280},height:{max:1080,ideal:1080,min:720}},a),audio:!!i.needMicrophone&&p({},o)};break;default:s=256,e={video:!!i.needCamera&&p({width:{max:352,ideal:352,min:320},height:{max:288,ideal:288,min:240}},a),audio:!!i.needMicrophone&&p({},o)}}navigator.mediaDevices?(this.numStreams++,navigator.mediaDevices.getUserMedia(e).then(function(e){t.localMediaStream=e,t.pcPuber?t.replaceLocalStream(e):t.emit("stream_created",e,t.attachStream(e,r))}).catch(function(e){console.log(e),t.emit("stream_create_error",7,e.name),"DevicesNotFoundError"===e.name||"NotFoundError"===e.name||"NotReadableError"===e.name||"TrackStartError"===e.name||"OverconstrainedError"===e.name||"ConstraintNotSatisfiedErrror"===e.name||"NotAllowedError"===e.name||e.name})):t.emit("stream_create_error",9,"NotSupportWebRTC")}else t.emit("stream_create_error",7,"NotFoundMicrophone")},c.prototype.replaceLocalStream=function(e){this.localMediaStream=e,this.emit("onLocalStreamUpdated",this.pcPuberPubId,e)},c.prototype.addStreams=function(){var e;for(e in this.peerConnections)this.peerConnections[e].addStream(this.localMediaStream)},c.prototype.attachStream=function(e,t){var i=t;return i.muted=!0,i.autoplay="autoplay",i.srcObject=e,i},c.prototype.createPeerConnection=function(r){var a=this,i=new RTCPeerConnection(t);this.peerConnections[r]=i;var o=null,s=null;return i.onicecandidate=function(e){if(e.candidate){var t={candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid},i=JSON.stringify({anyrtc:"trickle",body:{request:"configure",audio:!0,video:!0},candidate:t});a.emit("onSendToPeer",r,i)}},i.oniceconnectionstatechange=function(e){switch(i.iceConnectionState){case"connected":break;case"disconnected":case"failed":if("Suber"==i.rtcType){for(var t in a.subscribers)if(a.subscribers[t]==r){a.emit("onIceDisconnected",!1,t,r);break}}else"PubVid"==i.rtcType&&a.emit("onIceDisconnected",!0,"Puber",r)}console.log("oniceconnectionstatechange: "+i.iceConnectionState)},i.onopen=function(){},i.ontrack=function(e){var t="";for(var i in a.subscribers)if(a.subscribers[i]==r){t=i;break}if("video"===e.track.kind?o=e.track:"audio"===e.track.kind&&(s=e.track),null!==o&&null!==s){var n=new MediaStream([o,s]);a.emit("onRemoteStream",n,t)}},i.ondatachannel=function(e){},i},c.prototype.closePeerConnection=function(e){e&&e.close()};function l(e,t,n,r){var a=n.split("\r\n"),o=-1,s=!1,c=null,d="^a=rtpmap:(\\d+) "+e+"(/\\d+)+[\r]?$",l=new RegExp(d);for(i=0;i<a.length-1;i++){if(null!=(p=a[i].match(l))){c=p[1],o=i;break}}if(null==c)return n;for(d="^a=fmtp:"+c+" \\w+=\\d+.*[\r]?$",l.compile(d),i=0;i<a.length-1;i++){var p;if(null!=(p=a[i].match(l))){a[i]+=t?"; "+m+"="+r:"; "+h+"="+1e3*r,s=!0;break}}var u="";for(i=0;i<a.length-1;i++){if(u+=a[i]+"\r\n",!s&&i==o)u+=(t?"a=fmtp:"+c+" "+m+"="+r:"a=fmtp:"+c+" "+h+"="+1e3*r)+"\r\n"}return u}function p(e,t){return null===t||""===t?0===Object.keys(e).length||e:Object.assign(e,{deviceId:t})}setInterval(function(){if(null!=n){var e=n;if(e.audioDetect)for(chanId in e.peerConnections){var t=e.peerConnections[chanId];"Suber"==t.rtcType&&d(chanId,t)}}},250),e.AnyRTC=c}(this);